var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};var BACKGROUND_DEBUG=!0,sciTabsQuery={url:"http://127.0.0.1:9000/research/* http://localhost:9000/research/* https://scilocal.at.ispras.ru/research/* https://scigraph.at.ispras.ru/research/* https://scinoon.at.ispras.ru/research/* https://scinoon.com/research/*".split(" ")},sciserver=new SciServer(sciTabsQuery,BACKGROUND_DEBUG);
function sendRmUpdatedToTabs(a){a=$jscomp.makeIterator(a);for(var b=a.next();!b.done;b=a.next())browser.tabs.sendMessage(b.value.id,{name:messages.RM_UPDATED})}function handleReturnExtracted(a,b){BACKGROUND_DEBUG&&console.log("BG: extraction results arrive!");sciserver.saveAndProcessArticles(JSON.stringify(a.data.articles),b,a)}
function handleSelectedArticles(a){BACKGROUND_DEBUG&&(console.log("BG: selection received"),console.log(a.data));sciserver.saveResearchMap(JSON.stringify(a.data),function(){browser.tabs.query(sciTabsQuery).then(sendRmUpdatedToTabs,sciserver.onError)},a.map)}
function handleSetDefaultMap(a){BACKGROUND_DEBUG&&(console.log("BG: setting default map"),console.log(a));var b=a.data.map,c=a.data.origin;if(b&&c){var d=c+"/"+b;browser.storage.local.set(a.data);browser.storage.local.get("anotherMaps").then(function(a){a=a.anotherMaps;if(-1===a.indexOf(d)){var b=[d];b.push.apply(b,$jscomp.arrayFromIterable(a));browser.storage.local.set({anotherMaps:b.slice(0,maxCountOfMaps)})}});browser.tabs.query(sciTabsQuery).then(function(b){b=$jscomp.makeIterator(b);for(var c=
b.next();!c.done;c=b.next())browser.tabs.sendMessage(c.value.id,{name:messages.DEFAULT_MAP_CHANGED,data:a.data})},sciserver.onError)}}function handleGetTerms(a){sciserver.getTermsFromResearch(a.tab.id);sciserver.getTermsFromClusters(a.tab.id)}browser.runtime.onMessage.addListener(function(a,b){switch(a.name){case messages.SET_DEFAULT_MAP:handleSetDefaultMap(a);break;case messages.SELECTED_ARTICLES:handleSelectedArticles(a);break;case messages.RETURN_EXTRACTED:handleReturnExtracted(a,b);break;case messages.GET_TERMS:handleGetTerms(b)}});
var maxCountOfMaps=3,defaultMap="CERMINE",defaultServer="https://scigraph.at.ispras.ru";browser.storage.local.get("map").then(function(a){null==a.map&&browser.storage.local.set({map:defaultMap})},sciserver.onError);browser.storage.local.get("origin").then(function(a){null==a.origin&&browser.storage.local.set({origin:defaultServer})},sciserver.onError);browser.storage.local.get("topCount").then(function(a){null==a.topCount&&browser.storage.local.set({topCount:20})},sciserver.onError);
browser.storage.local.get("anotherMaps").then(function(a){null==a.anotherMaps&&browser.storage.local.set({anotherMaps:[defaultServer+"/"+defaultMap]})},sciserver.onError);
